// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String?
  role      String   @default("user") // user, admin
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Project {
  id          String    @id @default(uuid())
  name        String
  description String?
  status      String    @default("planning") // planning, in-progress, completed, on-hold
  deadline    DateTime?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  messages       Message[]
  tasks          Task[]
  requirements   Requirement[]
  timelineEvents TimelineEvent[]

  @@map("projects")
}

model Message {
  id          String   @id @default(uuid())
  source      String   // teams, slack
  sourceId    String   @map("source_id") // original message ID from platform
  channelId   String?  @map("channel_id")
  channelName String?  @map("channel_name")
  authorId    String   @map("author_id")
  authorName  String   @map("author_name")
  content     String
  messageType String   @default("chat") @map("message_type") // chat, transcription
  timestamp   DateTime
  projectId   String?  @map("project_id")
  createdAt   DateTime @default(now()) @map("created_at")

  project        Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  entities       Entity[]
  timelineEvents TimelineEvent[]
  tasks          Task[]
  requirements   Requirement[]

  @@unique([source, sourceId], name: "source_sourceId")
  @@index([projectId])
  @@index([timestamp])
  @@map("messages")
}

model AudioRecording {
  id                   String   @id @default(uuid())
  source               String   // teams, slack
  sourceId             String   @map("source_id")
  meetingTitle         String?  @map("meeting_title")
  fileUrl              String?  @map("file_url")
  storagePath          String?  @map("storage_path")
  durationSeconds      Int?     @map("duration_seconds")
  transcriptionStatus  String   @default("pending") @map("transcription_status") // pending, processing, completed, failed
  timestamp            DateTime
  createdAt            DateTime @default(now()) @map("created_at")

  transcriptions Transcription[]

  @@index([source, sourceId])
  @@index([transcriptionStatus])
  @@map("audio_recordings")
}

model Transcription {
  id                String   @id @default(uuid())
  audioRecordingId  String   @map("audio_recording_id")
  content           String
  speakers          Json?    // [{name, segments: [{start, end, text}]}]
  language          String   @default("en")
  confidenceScore   Float?   @map("confidence_score")
  createdAt         DateTime @default(now()) @map("created_at")

  audioRecording AudioRecording @relation(fields: [audioRecordingId], references: [id], onDelete: Cascade)

  @@index([audioRecordingId])
  @@map("transcriptions")
}

model Entity {
  id              String   @id @default(uuid())
  messageId       String   @map("message_id")
  entityType      String   @map("entity_type") // deadline, task, requirement, decision, person, etc.
  entityValue     String   @map("entity_value")
  confidenceScore Float?   @map("confidence_score")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([entityType])
  @@map("entities")
}

model Task {
  id              String    @id @default(uuid())
  projectId       String    @map("project_id")
  title           String
  description     String?
  assignee        String?
  status          String    @default("todo") // todo, in-progress, done
  priority        String    @default("medium") // low, medium, high
  dueDate         DateTime? @map("due_date")
  sourceMessageId String?   @map("source_message_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceMessage Message? @relation(fields: [sourceMessageId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([status])
  @@map("tasks")
}

model Requirement {
  id              String   @id @default(uuid())
  projectId       String   @map("project_id")
  description     String
  category        String   @default("functional") // functional, non-functional, constraint
  priority        String   @default("medium") // low, medium, high
  status          String   @default("proposed") // proposed, approved, implemented, rejected
  sourceMessageId String?  @map("source_message_id")
  createdAt       DateTime @default(now()) @map("created_at")

  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceMessage Message? @relation(fields: [sourceMessageId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([status])
  @@map("requirements")
}

model TimelineEvent {
  id              String   @id @default(uuid())
  projectId       String   @map("project_id")
  eventType       String   @map("event_type") // status_change, deadline_set, requirement_added, task_created, etc.
  description     String
  timestamp       DateTime
  sourceMessageId String?  @map("source_message_id")
  createdAt       DateTime @default(now()) @map("created_at")

  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceMessage Message? @relation(fields: [sourceMessageId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([timestamp])
  @@map("timeline_events")
}

model Integration {
  id           String   @id @default(uuid())
  platform     String   // teams, slack
  accessToken  String   @map("access_token")
  refreshToken String?  @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  userId       String?  @map("user_id")
  workspaceId  String?  @map("workspace_id")
  workspaceName String? @map("workspace_name")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([platform])
  @@index([userId])
  @@map("integrations")
}
